# Google Cloud 環境初期設定マニュアル

本アプリケーションを Google Cloud 上で動作させるための初期設定手順です。

## 1. プロジェクトの作成と設定

### 1.1. プロジェクトの作成

Google Cloud コンソールまたは `gcloud` コマンドでプロジェクトを作成します。

```bash
gcloud projects create [YOUR_PROJECT_ID]
gcloud config set project [YOUR_PROJECT_ID]
```

### 1.2. 課金の有効化

Google Cloud コンソールの「お支払い」セクションから、プロジェクトに請求先アカウントをリンクしてください。

## 2. API の有効化

以下のコマンドを実行して、必要な API を有効化します。

```bash
gcloud services enable \
  cloudbuild.googleapis.com \
  run.googleapis.com \
  artifactregistry.googleapis.com \
  datastore.googleapis.com \
  cloudtasks.googleapis.com \
  cloudscheduler.googleapis.com
```

## 3. サービスアカウントと権限設定

Cloud Build がデプロイを行うために必要な権限を設定します。

### 3.1. 変数の設定

```bash
PROJECT_ID=$(gcloud config get-value project)
PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)")
SA_EMAIL="cloudbuild@${PROJECT_ID}.iam.gserviceaccount.com" # Cloud Build のデフォルトSAを使用する場合、またはカスタムSA
```

※ Cloud Build のデフォルトサービスアカウントを使用する場合、メールアドレスは `${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com` となります。セキュリティ向上のため、専用のサービスアカウントを作成して使用することを推奨します。

### 3.2. IAM ロールの付与

```bash
# Artifact Registry への書き込み
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:${SA_EMAIL}" \
  --role="roles/artifactregistry.writer"

# Cloud Run へのデプロイ
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:${SA_EMAIL}" \
  --role="roles/run.admin"

# サービスアカウントユーザー (Cloud Run 実行用SAになりすますため)
gcloud iam service-accounts add-iam-policy-binding ${PROJECT_NUMBER}-compute@developer.gserviceaccount.com \
    --member="serviceAccount:${SA_EMAIL}" \
    --role="roles/iam.serviceAccountUser"
```

## 4. Artifact Registry リポジトリの作成

コンテナイメージを保存するリポジトリを作成します。

```bash
gcloud artifacts repositories create toybox \
  --repository-format=docker \
  --location=asia-northeast1 \
  --description="Docker repository for ToyBox project"
```

## 5. データベース (Datastore) の準備

本アプリケーションはユーザーデータの保存に **Cloud Firestore (Datastore モード)** を使用します。

1.  Google Cloud コンソールの「Datastore」セクション (または Firestore) に移動します。
    - ※ 初めてアクセする場合、「モードの選択」画面が表示されることがあります。**「Datastore モード」**を選択してください ("Native モード" ではありません)。
2.  データベースの作成画面で以下を設定します:
    - **データベース ID**: `(default)` (変更せずデフォルトのまま)
    - **ロケーション**: `asia-northeast1` (東京) - Cloud Run と同じリージョンを推奨
    - **Secure rules**: (Datastore モードの場合、IAM で管理されるため通常は設定不要ですが、デフォルトのまま進めます)
3.  「データベースを作成」をクリックします。

完了後、ステータスが「準備完了」になれば使用可能です。

### 5.2. インデックスの作成

チャット履歴の取得などに複合インデックスが必要です。以下のコマンドでインデックスを作成してください（完了までに数分〜数時間かかる場合があります）。

```bash
gcloud datastore indexes create index.yaml
```

> [!IMPORTANT]
> インデックスの構築（Building）には、数分〜数十分かかる場合があります。
> 構築中は、アプリケーションからチャット履歴を取得する際に `500 Internal Server Error` (Need Index) が発生します。
> Google Cloud コンソールの [Datastore] > [インデックス] ページでステータスが **「Serving (提供中)」** になるまで待機してください。
