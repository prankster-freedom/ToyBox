# デプロイ手順書 (DEPLOYMENT.md)

本アプリケーションのデプロイ手順について説明します。
主に Cloud Build を使用した自動デプロイを想定していますが、手動デプロイの手順も併記します。

## 1. Cloud Build による自動デプロイ

Git リポジトリの `main` ブランチへのプッシュをトリガーとして、自動的にデプロイが行われます。

### 1.1. 事前準備

「Google Cloud 環境初期設定マニュアル」に従い、Cloud Build トリガーが設定されていることを確認してください。

### 1.2. デプロイ手順

1.  ローカルで変更をコミットします。
2.  `main` ブランチにプッシュします。

    ```bash
    git push origin main
    ```

3.  Google Cloud コンソールの [Cloud Build] > [履歴] ページで、ビルドの進行状況を確認できます。
4.  ビルドとデプロイが成功すると、Cloud Run の新しいリビジョンがトラフィックを処理し始めます。

## 2. 手動デプロイ

`gcloud` コマンドを使用して、ローカルから直接デプロイすることも可能です（緊急時やテスト用）。

### 2.1. コンテナイメージのビルドとプッシュ

```bash
# 変数設定
PROJECT_ID=$(gcloud config get-value project)
REGION="asia-northeast1"
IMAGE_NAME="${REGION}-docker.pkg.dev/${PROJECT_ID}/toybox/toybox-image"

# ビルド
docker build -t $IMAGE_NAME .

# プッシュ (Docker の認証設定が必要な場合があります: gcloud auth configure-docker ${REGION}-docker.pkg.dev)
docker push $IMAGE_NAME
```

### 2.2. Cloud Run へのデプロイ

```bash
gcloud run deploy toybox-service \
  --image $IMAGE_NAME \
  --platform managed \
  --region $REGION \
  --allow-unauthenticated
```

## 3. 環境変数の設定

`Dockerfile` にて `ENV NODE_ENV=production` が設定されているため、Cloud Run 上では自動的に本番モードで動作します。
その他の環境変数（API キーなど）が必要な場合は、Cloud Run のコンソールまたは `gcloud` コマンドで設定してください。

```bash
gcloud run services update toybox-service \
  --update-env-vars KEY=VALUE
```

## 4. 構成上の注意点

### 4.1. プロキシと認証 (Trust Proxy)

Cloud Run はロードバランサーを経由してトラフィックを受信するため、Express アプリケーション側で `trust proxy` の設定が必要です。
これにより、`X-Forwarded-Proto` ヘッダーが正しく解釈され、HTTPS 通信として認識されます。
この設定が欠落すると、`secure: true` 属性を持つセッション Cookie がブラウザに保存されず、ログインに失敗します。
本アプリケーションでは `index.js` にて `app.set('trust proxy', 1);` を設定済みです。
