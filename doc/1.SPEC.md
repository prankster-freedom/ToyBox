# 要求仕様書 (SPEC.md)

## 1. 概要

### プロジェクトの目標 (Goals)

このプロジェクトは、モダンで標準的な技術スタックを用いた Web アプリケーション開発のひな形となるサンプルを提供することを目的としています。

#### プロジェクトで取り上げる技術のテーマは大きく下記の技術である。

- クラウドサービス
- フロントエンド、バックエンド
- 生成 AI
- マイクロサービス
- コンテナ技術
- gRPC, REST API, Web API, HTTP/2, HTTP/3
- HTML Living Standard
- Google OAuth
- SPA
- Web コンポーネント, ES Modules
- Vue.js, Node.js
- CI, CD
- NoSQL

### プロジェクトの方針

- 個人開発者が費用面で開発を継続できるように、オープンなエコシステムをうまく活用する。
- Cloud サービスには Google Cloud を利用することを前提として設計を最適化してよいが、今後他のサービスを利用する場合にも困らないように依存関係は局所化するように設計すること

#### 以下に述べる技術は利用禁止とする。

- React
- firebase
- JWT

## 2. アクター

- **ゲスト:** 認証していない匿名ユーザー
- **ユーザー:** Google アカウントで認証済みのユーザー
- **開発者:** 開発・テスト目的でシステムを操作する人物。開発者向けUIを用いて各APIを直接実行し、バックエンドのデバッグ情報を取得できる。開発モードでは認証バイパスやモックユーザー情報の利用が許可される（NFR6 に従う）。

## 3. 機能要求 (FR)

- **FR1: Web UIの提供**
  - FR1-1: システムは、投稿の閲覧など複数の機能を組み合わせた、一般ユーザー向けのUIを提供する。
  - FR1-2: システムは、各APIエンドポイントを個別に実行し、動作確認ができる開発者向けのUI（開発者が利用）を提供する。
    - 開発者向けUIは、APIレスポンスに含まれるデバッグ情報を画面に表示できること（NFR5 を参照）。

- **FR2: ユーザー認証**
  - FR2-1: ユーザーは Google アカウントを利用して認証できる。
  - FR2-2: ユーザーはログアウトできる。
  - FR2-3: 認証済みのユーザーは、自身のユーザー情報を取得できる。
- **FR3: 投稿の閲覧**
  - FR3-1: すべてのユーザー（ゲストおよびユーザー）は、投稿の一覧を閲覧できる。
  - FR3-2: すべてのユーザー（ゲストおよびユーザー）は、個別の投稿内容を閲覧できる。
- **FR4: 投稿の管理**
  - FR4-1: ユーザーは新しい投稿を作成できる。
  - FR4-2: ユーザーは自分が作成した投稿を削除できる。
- **FR5: グリーティング機能**
  - FR5-1: システムは、名前を受け取って挨拶を返すAPI (`/api/greet`) を提供する。
- **FR6: システムヘルスチェック**
  - FR6-1: システムは、外部から稼働状態を確認するためのAPI (`/api/health`) を提供する。

- **FR7: AIチャット機能**
  - FR7-1: 認証済みユーザーは、AIと対話するためのAPI (`/api/chat`) を利用できる。

## 4. 非機能要求 (NFR)

- **NFR1:** `GEMINI.md`に記載された技術テーマと方針に準拠する。
- **NFR2:** Google Cloud をデプロイ先として想定する。
- **NFR3:** React および Firebase は使用しない。
- **NFR4:** ローカル環境、クラウド環境ともに開発モード中はなるべく多くのデバッグ情報を表示するようにしてください。特に関数呼び出し前後には全てデバッグ用のログ機能を入れてください。 リリースモードでビルドしたときにはそれらを簡単に無効化できるようにしてください。 特に指示がない限り開発モードでビルドしてください。
- **NFR5:** 開発モード時、開発者向けUIはAPI実行時にバックエンドで生成されたデバッグログを画面に表示できること。これを実現するため、APIレスポンスにはデバッグ情報を含めることができる。開発者はこのUIを用いて任意のAPIを呼び出し、レスポンス内のデバッグ情報を確認できる。
- **NFR6: 開発モードの認証**
  - **NFR6-1:** 開発モード (`NODE_ENV !== 'production'`) では、認証をバイパスする。APIへのリクエストは、認証済みユーザーからのものとして扱われ、モックのユーザー情報が使用される。開発者が開発者向けUIから行ったリクエストは、この挙動の対象となる。
  - **NFR6-2:** 開発モードの挙動（認証バイパス、有効なモックユーザー情報のフォーマット、デバッグ情報の有効化）は明確にドキュメント化し、開発者が安全に利用できるようにする。

## 5. ユースケース図

```plantuml
@startuml
title ユースケース図
left to right direction

actor "ゲスト" as Guest
actor "ユーザー" as User
actor "開発者" as Developer

rectangle "ブログアプリケーション" as App {
  User -- (アカウントを管理する)
  User -- (投稿を管理する)
  User -- (AIとチャットする)
  Guest -- (投稿を閲覧する)
  User -- (投稿を閲覧する)
  Developer -- (投稿を閲覧する)
  Developer -- (APIを実行・デバッグする)
  Developer -- (アカウントを管理する)
  Developer -- (投稿を管理する)
}
@enduml
```

## 6. シーケンス図

### 6.1. 投稿を閲覧する (UC_VIEW)

ゲスト、ユーザー、開発者共通のユースケースです。

```plantuml
@startuml
actor "ゲスト / ユーザー / 開発者" as Actor
participant "システム" as System

Actor -> System: 投稿一覧の表示を要求
System --> Actor: 投稿一覧を表示

alt 個別投稿の閲覧
    Actor -> System: 特定の投稿の表示を要求
    System --> Actor: 投稿の詳細を表示
end
@enduml
```

### 6.2. アカウントを管理する (UC_AUTH)

Google OAuth を利用した認証とログアウトのフローです。

```plantuml
@startuml
title アカウント管理のシーケンス (ユーザー)

actor ユーザー
participant "システム" as System
participant "Google" as Google

alt ログイン/新規登録 (通常)
    ユーザー -> System: Googleアカウントでのログインを要求
    System -> ユーザー: Googleの認証ページへリダイレクト
    ユーザー -> Google: Googleアカウントでログイン
    Google -> System: ユーザー情報を通知
    System -> ユーザー: ログイン成功を表示 (トップページへリダイレクト)
end

alt ログアウト
    ユーザー -> System: ログアウトを要求
    System --> ユーザー: ログアウト完了を表示 (トップページへリダイレクト)
end
@enduml
```

### 6.3. 投稿を管理する (UC_MANAGE)

認証済みユーザー及び開発者の投稿作成、削除のフローです。

```plantuml
@startuml
title 投稿管理のシーケンス

actor ユーザー
participant "システム" as System

alt 投稿作成
    ユーザー -> System: 新規投稿作成を要求 (内容入力)
    System --> ユーザー: 作成完了を表示
end

alt 投稿削除
    ユーザー -> System: 自身の投稿の削除を要求
    System --> ユーザー: 削除完了を表示
end

@enduml
```

```plantuml
@startuml
title 投稿管理のシーケンス

actor 開発者
participant "システム" as System


alt 開発者による直接実行 (開発者向けUI)
    開発者 -> System: 開発者向けUIから API を呼び出す（例: POST /api/posts）
    System --> 開発者: APIレスポンス + デバッグ情報を返す
end
@enduml
```

### 6.4. AIとチャットする (UC_CHAT)

認証済みユーザーがAIと対話するフローです。

```plantuml
@startuml
title AIチャットのシーケンス

actor ユーザー
participant "システム" as System
participant "AIエンジン" as AIEngine

ユーザー -> System: チャットメッセージを送信 (POST /api/chat)
System -> AIEngine: ユーザーメッセージを転送
AIEngine --> System: AIからの応答を生成
System --> ユーザー: AIの応答を返す
@enduml
```

## 7. API仕様

> [!NOTE]
表中の「リクエストボディ」列が「なし」となっているAPIは、リクエストボディを持ちません。
パラメータが必要な場合は、URLのパス（例: `/api/posts/:id` の `:id` 部分）に含まれます。

### 7.1. 投稿 (Posts)

| 機能 | 機能要求ID | エンドポイント | 認証 | 認可 | リクエストボディ | 成功レスポンス |
|---|---|---|---|---|---|---|
| 投稿一覧の取得 | FR3-1 | `GET /api/posts` | 不要 | - | なし | `200 OK`<br>下記参照 |
| 個別投稿の取得 | FR3-2 | `GET /api/posts/:id` | 不要 | - | なし | `200 OK`<br>下記参照 |
| 投稿の作成 | FR4-1 | `POST /api/posts` | **必要** | - | 下記参照 | `201 Created`<br>下記参照 |
| 投稿の削除 | FR4-2 | `DELETE /api/posts/:id` | **必要** | 投稿作成者 | なし | `204 No Content` |

#### 投稿一覧の取得: 成功レスポンス例
```json
[
  {
    "id": "post-id-1",
    "content": "最初の投稿です。",
    "author": {
      "id": "google-user-id-1",
      "displayName": "ユーザー名1",
      "photo": "http://.../photo.jpg"
    },
    "createdAt": "2023-10-27T12:00:00Z"
  },
  {
    "id": "post-id-2",
    "content": "二番目の投稿です。",
    "author": {
      "id": "google-user-id-2",
      "displayName": "ユーザー名2",
      "photo": "http://.../photo.jpg"
    },
    "createdAt": "2023-10-27T12:01:00Z"
  }
]
```

#### 個別投稿の取得: 成功レスポンス例
```json
{
  "id": "post-id-1",
  "content": "最初の投稿です。",
  "author": {
    "id": "google-user-id-1",
    "displayName": "ユーザー名1",
    "photo": "http://.../photo.jpg"
  },
  "createdAt": "2023-10-27T12:00:00Z"
}
```

#### 投稿の作成: リクエストボディ例
```json
{
  "content": "新しい投稿内容です。"
}
```

#### 投稿の作成: 成功レスポンス例
```json
{
  "id": "post-id-new",
  "content": "新しい投稿内容です。",
  "author": {
    "id": "google-user-id-current",
    "displayName": "現在のユーザー名",
    "photo": "http://.../photo.jpg"
  },
  "createdAt": "2023-10-27T12:02:00Z"
}
```

### 7.2. ユーザー (User)

| 機能 | 機能要求ID | エンドポイント | 認証 | 認可 | リクエストボディ | 成功レスポンス |
|---|---|---|---|---|---|---|
| 認証ユーザー情報の取得 | FR2-3 | `GET /user` | **必要** | - | なし | `200 OK`<br>下記参照 |

#### 認証ユーザー情報の取得: 成功レスポンス例
```json
{
  "provider": "google",
  "id": "123456789012345678901",
  "displayName": "ユーザー名",
  "name": {
    "familyName": "姓",
    "givenName": "名"
  },
  "emails": [
    {
      "value": "user@example.com",
      "verified": true
    }
  ],
  "photos": [
    {
      "value": "https://.../photo.jpg"
    }
  ]
}
```

### 7.3. グリーティング (Greeting)

| 機能 | 機能要求ID | エンドポイント | 認証 | 認可 | リクエストボディ | 成功レスポンス |
|---|---|---|---|---|---|---|
| 挨拶の実行 | FR5-1 | `POST /api/greet` | **必要（ただし開発モードではバイパス可）** | - | 下記参照 | `200 OK`<br>下記参照 |

#### 挨拶の実行: リクエストボディ例
```json
{
  "name": "World"
}
```

#### 挨拶の実行: 成功レスポンス例
```json
{
  "message": "Hello, World!"
}
```

### 7.4. システム (System)

| 機能 | 機能要求ID | エンドポイント | 認証 | 認可 | リクエストボディ | 成功レスポンス |
|---|---|---|---|---|---|---|
| ヘルスチェック | FR6-1 | `GET /api/health` | 不要 | - | なし | `200 OK`<br>下記参照 |

#### ヘルスチェック: 成功レスポンス例
```json
{
  "status": "ok",
  "timestamp": "..."
}
```

### 7.5. AIチャット (AI Chat)

| 機能 | 機能要求ID | エンドポイント | 認証 | 認可 | リクエストボディ | 成功レスポンス |
|---|---|---|---|---|---|---|
| AIとの対話 | FR7-1 | `POST /api/chat` | **必要** | - | 下記参照 | `200 OK`<br>下記参照 |

#### AIとの対話: リクエストボディ例
```json
{
  "message": "こんにちは"
}
```

#### AIとの対話: 成功レスポンス例
```json
{
  "reply": "こんにちは、何かお手伝いできますか？"
}
```
