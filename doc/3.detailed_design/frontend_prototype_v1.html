<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ToyBox - Final Prototype (Round)</title>
    <style>
        /* Imported Fonts: Quicksand (Round EN), Zen Maru Gothic (Round JP/EN) */
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&family=Zen+Maru+Gothic:wght@300;400;500;700;900&display=swap');

        :root {
            --primary-bg: #fdf6f6;
            --accent-gold: #d4af37;
            --accent-rose: #e09f9f;
            --text-dark: #5a4d4d; /* Softer dark */
            --glass-card: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.9);
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at 50% 50%, #fff0f5 0%, #fff 100%);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: font-family 0.3s;
        }

        /* --- FONTS & LANG --- */
        body.lang-en {
            font-family: 'Quicksand', sans-serif; /* Rounded Sans for EN */
        }
        body.lang-jp {
            font-family: 'Zen Maru Gothic', sans-serif; /* Rounded Gothic for JP */
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        /* Titles / Accents that were previously Serif are now Rounded Bold */
        .title-font {
            font-weight: 700;
        }

        /* --- AMBIENT FLORAL BG --- */
        .flower-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            filter: blur(40px);
            opacity: 0.6;
            pointer-events: none;
        }
        .petal {
            position: absolute;
            background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            border-radius: 50% 0 50% 0;
            animation: floatPetal 20s infinite ease-in-out;
        }
        .p1 { width: 300px; height: 300px; top: -50px; left: -50px; transform: rotate(45deg); opacity: 0.4; }
        .p2 { width: 400px; height: 400px; bottom: -100px; right: -50px; background: linear-gradient(45deg, #a18cd1 0%, #fbc2eb 100%); animation-delay: -5s; opacity: 0.3; }
        .p3 { width: 150px; height: 150px; top: 20%; left: 70%; background: #ffd1ff; animation-delay: -10s; filter: blur(30px); opacity: 0.5; }

        @keyframes floatPetal {
            0%, 100% { transform: translate(0, 0) rotate(0deg) scale(1); }
            50% { transform: translate(40px, -40px) rotate(10deg) scale(1.05); }
        }

        /* --- LANG SWITCHER --- */
        .lang-switch {
            position: absolute;
            top: 25px;
            left: 30px;
            z-index: 300;
            display: flex;
            gap: 5px;
            background: rgba(255,255,255,0.6);
            padding: 4px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }
        .lang-btn {
            border: none;
            background: transparent;
            font-family: inherit; /* Inherit rounded font */
            font-size: 0.8rem;
            color: #aaa;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 15px;
            transition: all 0.3s;
            font-weight: 600;
        }
        .lang-btn.active {
            background: white;
            color: var(--text-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- NAVIGATION --- */
        .nav-header {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            display: flex;
            gap: 20px;
        }
        .nav-btn {
            background: none;
            border: none;
            font-family: inherit;
            font-size: 1.1rem;
            letter-spacing: 1px;
            color: #aaa;
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
            padding: 5px 10px;
            font-weight: 600;
        }
        .nav-btn.active { 
            color: var(--text-dark); 
        }
        .nav-btn::after {
            content: '';
            position: absolute;
            bottom: 0; left: 50%; width: 0; height: 2px; /* Thicker for round feel */
            border-radius: 1px;
            background: var(--accent-gold);
            transition: all 0.3s;
            transform: translateX(-50%);
        }
        .nav-btn.active::after { width: 80%; }

        /* --- VIEWPORT --- */
        .viewport {
            width: 100%;
            height: 100%;
            position: relative;
        }
        .scene {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s ease-in-out;
        }
        .scene.active { opacity: 1; pointer-events: auto; }


        /* === SCENE 1: CHAT === */
        .stage {
            width: 100%;
            height: 100%;
            perspective: 1000px;
            position: relative;
            overflow: hidden;
        }

        .chest-target {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%) scale(0.6);
            font-size: 3.5rem;
            filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.6));
            z-index: 10;
            cursor: pointer;
            transition: transform 0.3s;
            opacity: 0.9;
        }
        .chest-target:hover { transform: translateX(-50%) scale(0.7); opacity: 1; }

        .curved-stream {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transform-style: preserve-3d;
            pointer-events: none;
        }

        .card {
            position: absolute;
            left: 50%;
            top: 0;
            width: 60%; 
            max-width: 550px;
            min-width: 300px;
            padding: 25px 35px;
            background: var(--glass-card);
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
            border: 1px solid var(--glass-border);
            pointer-events: auto;
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform, opacity;
            display: flex;
            flex-direction: column;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.8;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 1px solid rgba(212, 175, 55, 0.15);
            pointer-events: none;
            border-radius: 14px; /* Matches outer roundness */
        }

        .card.user {
            background: #fffbfb;
            border-left: 4px solid var(--accent-rose); /* Thicker for round feel */
        }
        .card.ai {
            background: #ffffff;
            border-right: 4px solid #b2bec3;
        }

        .card-meta {
            font-family: inherit;
            font-weight: 600;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .msg-text { 
            font-size: 1.05rem; 
            color: #555; 
        }

        .card-action {
            font-size: 1.1rem;
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.2s;
            color: var(--accent-gold);
            font-style: normal;
        }
        .card:hover .card-action { opacity: 1; transform: scale(1.1); }

        /* INPUT DOCK (Global) */
        .input-dock {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 650px;
            z-index: 100;
            display: flex;
        }

        .input-wrapper {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 10px 10px 10px 30px;
            display: flex;
            align-items: center;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s;
        }
        .input-wrapper:focus-within {
            background: rgba(255,255,255,0.95);
            box-shadow: 0 15px 40px rgba(0,0,0,0.08);
            transform: translateY(-2px);
            border-color: rgba(224, 159, 159, 0.3);
        }

        .main-input {
            flex: 1;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-dark);
            outline: none;
            padding-right: 15px;
        }
        .main-input::placeholder { color: #ccc; letter-spacing: 0.05em; font-style: italic; }

        .send-btn {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd1ff 0%, #fad0c4 100%);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 182, 193, 0.3);
            transition: transform 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        .send-btn:hover { transform: scale(1.05) rotate(10deg); }


        /* === SCENE 2: DIARY === */
        .diary-container {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 100px 30px 50px 30px;
            box-sizing: border-box;
            background: rgba(255,255,255,0.2);
        }

        .diary-title {
            text-align: center;
            font-size: 2.2rem; /* Slightly smaller for Quicksand */
            background: linear-gradient(90deg, #d4af37, #e09f9f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 50px;
            text-shadow: 0 5px 15px rgba(255,255,255,0.8);
        }

        .masonry-grid {
            column-count: 2;
            column-gap: 30px;
            max-width: 900px;
            margin: 0 auto;
        }
        @media (min-width: 768px) { .masonry-grid { column-count: 3; } }

        .polaroid {
            break-inside: avoid;
            background: white;
            padding: 15px 15px 45px 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            transform: rotate(-1deg);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            border-radius: 4px; /* Polaroids are usually squareish, but let's soften slightly */
        }
        .polaroid:nth-child(even) { transform: rotate(1deg); }
        .polaroid:hover { transform: rotate(0) scale(1.05); box-shadow: 0 20px 50px rgba(0,0,0,0.1); z-index: 10; }

        .polaroid-img-placeholder {
            width: 100%;
            height: 160px;
            background: #fafafa;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: #e0e0e0;
            margin-bottom: 20px;
            border: 1px solid #f5f5f5;
            border-radius: 2px;
        }
        
        .polaroid-text {
            font-family: inherit; 
            font-size: 0.95rem;
            line-height: 1.7;
            color: #555;
            text-align: center;
            padding: 0 5px;
        }
        
        .polaroid-date {
            position: absolute;
            bottom: 15px;
            right: 20px;
            font-family: inherit;
            font-size: 0.75rem;
            color: #bbb;
        }
        
        .del-btn {
            position: absolute;
            top: -10px; right: -10px;
            width: 28px; height: 28px;
            border-radius: 50%;
            background: var(--accent-rose);
            color: white;
            border: none;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display:flex; justify-content:center; align-items:center;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .polaroid:hover .del-btn { opacity: 1; }

    </style>
</head>
<body class="lang-en"> <!-- Default English -->

    <div class="flower-bg">
        <div class="petal p1"></div>
        <div class="petal p2"></div>
        <div class="petal p3"></div>
    </div>

    <!-- Language Switcher -->
    <div class="lang-switch">
        <button class="lang-btn active" onclick="setLang('en')" id="btn-lang-en">EN</button>
        <button class="lang-btn" onclick="setLang('jp')" id="btn-lang-jp">JP</button>
    </div>

    <nav class="nav-header">
        <button class="nav-btn active title-font" onclick="switchScene('chat')" id="btn-chat" data-key="nav_chat">Dialogue</button>
        <button class="nav-btn title-font" onclick="switchScene('diary')" id="btn-diary" data-key="nav_diary">Collection</button>
    </nav>

    <div class="viewport">
        <!-- SCENE: CHAT -->
        <div class="scene active" id="scene-chat">
            <div class="stage">
                <div class="chest-target" onclick="switchScene('diary')">üóùÔ∏è</div>
                <div class="curved-stream" id="stream"></div>
            </div>
        </div>

        <!-- SCENE: DIARY -->
        <div class="scene" id="scene-diary">
            <div class="diary-container">
                <div class="diary-title title-font" data-key="diary_title">Precious Moments</div>
                <div class="masonry-grid" id="diaryGrid"></div>
            </div>
        </div>

        <!-- GLOBAL INPUT DOCK -->
        <div class="input-dock" id="inputDock">
            <div class="input-wrapper">
                <input type="text" class="main-input" id="inputBox" placeholder="Write something beautiful..." onkeypress="handleEnter(event)">
                <button class="send-btn" onclick="handleSubmit()">‚ú¶</button>
            </div>
        </div>
    </div>

    <script>
        /* === DICTIONARY === */
        const RESOURCES = {
            en: {
                nav_chat: "Dialogue",
                nav_diary: "Collection",
                diary_title: "Precious Moments",
                input_placeholder: "Write something beautiful...",
                ai_welcome: "Welcome to your sanctuary.\nHow are you feeling today?",
                ai_resp: "That is truly beautiful.",
                save_title: "Collect",
                meta_ai: "ToyBox AI",
                meta_user: "You",
                dateFormat: (d) => d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
            },
            jp: {
                nav_chat: "„Åä„ÅØ„Å™„Åó",
                nav_diary: "ÊÉ≥„ÅÑÂá∫",
                diary_title: "Â§ßÂàá„Å™Ë®ÄËëâ„Åü„Å°",
                input_placeholder: "„Åì„Åì„Å´ÊÉ≥„ÅÑ„ÇíÁ∂¥„Å£„Å¶„Åè„Å†„Åï„ÅÑ...",
                ai_welcome: "„Çà„ÅÜ„Åì„Åù„ÄÇ„ÅÇ„Å™„Åü„ÅÆË®ÄËëâ„ÅØ„ÄÅ\n„Åì„Åì„ÅßÂ§ßÂàá„Å™ÊÉ≥„ÅÑÂá∫„Å´„Å™„Çä„Åæ„Åô„ÄÇ",
                ai_resp: "„Åù„Çå„ÅØÁ¥†Êïµ„Å™ËÄÉ„Åà„Åß„Åô„Å≠„ÄÇ",
                save_title: "ÊÉ≥„ÅÑÂá∫„Å´ÊÆã„Åô",
                meta_ai: "AI",
                meta_user: "„ÅÇ„Å™„Åü",
                dateFormat: (d) => d.toLocaleDateString('ja-JP').replace(/\//g, '.')
            }
        };

        let currentLang = 'en';
        let activeScene = 'chat';

        function setLang(lang) {
            currentLang = lang;
            document.body.className = `lang-${lang}`;
            
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-lang-${lang}`).classList.add('active');

            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if(RESOURCES[lang][key]) el.textContent = RESOURCES[lang][key];
            });

            document.getElementById('inputBox').placeholder = RESOURCES[lang].input_placeholder;
            
            if(activeScene === 'chat') resetChatInLang();
        }

        /* === CHAT LOGIC === */
        const stream = document.getElementById('stream');
        const inputDock = document.getElementById('inputDock');
        let messages = [];

        function resetChatInLang() {
            messages = [
                { id: 1, type: 'ai', text: RESOURCES[currentLang].ai_welcome }
            ];
            renderChat();
        }

        window.addEventListener('resize', renderChat);

        function renderChat() {
            while(stream.children.length > messages.length) stream.removeChild(stream.firstChild);
            while(stream.children.length < messages.length) {
                const i = stream.children.length;
                const msg = messages[i];
                const el = document.createElement('div');
                el.className = `card ${msg.type}`;
                
                const meta = msg.type === 'ai' ? RESOURCES[currentLang].meta_ai : RESOURCES[currentLang].meta_user;
                const tooltip = RESOURCES[currentLang].save_title;
                const html = `
                    <div class="card-meta">
                        <span>${meta}</span>
                        <span class="card-action" onclick="saveToDiary(this)" title="${tooltip}">üíé</span>
                    </div>
                    <div class="msg-text">${msg.text}</div>
                `;
                el.innerHTML = html;
                stream.appendChild(el);
            }

            const total = messages.length;
            const windowHeight = window.innerHeight;
            const inputRect = inputDock.getBoundingClientRect();
            const inputTop = inputRect.top === 0 ? windowHeight - 100 : inputRect.top;
            
            const safeBottomY = inputTop - 30; // Margin from input dock
            const curveThresholdY = windowHeight * 0.25;

            Array.from(stream.children).forEach((node, index) => {
                const reverseIndex = (total - 1) - index;
                const visualSpacing = 180;
                const cardHeight = node.offsetHeight || 120;
                
                let targetBottomY = safeBottomY - (reverseIndex * visualSpacing);
                let targetTopY = targetBottomY - cardHeight;
                let transformY = targetTopY;
                let z = 0; let xOffset = 0; let scale = 1; let opacity = 1;

                if (transformY > curveThresholdY) {
                    z = 0 - (reverseIndex * 30);
                    scale = 1 - (reverseIndex * 0.03);
                } else {
                    const excess = curveThresholdY - transformY;
                    transformY = curveThresholdY - (excess * 0.25); 
                    z = - (excess * 6);
                    xOffset = Math.pow(excess, 1.25) * 0.4;
                    scale = Math.max(0, 1 - (reverseIndex * 0.05) - (excess * 0.005));
                    opacity = Math.max(0, 1 - (excess * 0.005));
                }
                
                if (opacity <= 0.05) {
                    node.style.opacity = 0; node.style.visibility = 'hidden';
                } else {
                    node.style.opacity = opacity; node.style.visibility = 'visible';
                }

                node.style.transform = `translate(-50%, 0) translate3d(${xOffset}px, ${transformY}px, ${z}px) scale(${scale})`;
                node.style.zIndex = 1000 - reverseIndex;
            });
        }

        function handleEnter(e) { if(e.key === 'Enter') handleSubmit(); }

        function handleSubmit() {
            const inp = document.getElementById('inputBox');
            const text = inp.value.trim();
            if(!text) return;
            
            if(activeScene === 'chat') {
                addChatMsg(text);
            } else {
                addDiaryDirect(text);
            }
            inp.value = '';
        }

        function addChatMsg(text) {
            messages.push({ type: 'user', text: text });
            renderChat();
            requestAnimationFrame(renderChat);

            setTimeout(() => {
                messages.push({ type: 'ai', text: RESOURCES[currentLang].ai_resp });
                renderChat();
                requestAnimationFrame(renderChat);
            }, 800);
        }

        function addDiaryDirect(text) {
            const grid = document.getElementById('diaryGrid');
            const icons = ['üå∏', '‚ú®', 'üíé', 'üîë', 'üïäÔ∏è'];
            const icon = icons[Math.floor(Math.random() * icons.length)];
            const dateStr = RESOURCES[currentLang].dateFormat(new Date());

            const p = document.createElement('div');
            p.className = 'polaroid';
            p.style.transform = `rotate(${Math.random() * 4 - 2}deg)`;
            
            // Highlight effect for new entry
            p.style.animation = 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            
            p.innerHTML = `
                <button class="del-btn" onclick="deleteMem(this)">√ó</button>
                <div class="polaroid-img-placeholder">${icon}</div>
                <div class="polaroid-text">${text}</div>
                <div class="polaroid-date">${dateStr}</div>
            `;
            grid.prepend(p);
        }
        
        // Add CSS for popIn
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes popIn {
                0% { opacity: 0; transform: scale(0.5) rotate(10deg); }
                100% { opacity: 1; transform: scale(1) rotate(${Math.random() * 4 - 2}deg); }
            }
        `;
        document.head.appendChild(style);


        /* === DIARY LOGIC === */
        function saveToDiary(btn) {
            const card = btn.closest('.card');
            const text = card.querySelector('.msg-text').textContent;
            
            // Clone Animation (Flying Polaroid)
            const clone = card.cloneNode(true);
            const rect = card.getBoundingClientRect();
            clone.style.position = 'fixed';
            clone.style.left = rect.left + 'px';
            clone.style.top = rect.top + 'px';
            clone.style.width = rect.width + 'px';
            clone.style.zIndex = 2000;
            clone.style.transition = 'all 0.8s ease';
            clone.style.boxShadow = '0 20px 50px rgba(0,0,0,0.2)';
            // Remove actions from clone
            clone.querySelector('.card-action').style.display = 'none';
            document.body.appendChild(clone);
            
            requestAnimationFrame(() => {
                const chestRect = document.querySelector('.chest-target').getBoundingClientRect();
                clone.style.transform = 'scale(0.05) rotate(720deg)';
                clone.style.opacity = '0';
                clone.style.left = chestRect.left + 'px';
                clone.style.top = chestRect.top + 'px';
            });
            setTimeout(() => clone.remove(), 800);

            // Add real entry
            addDiaryDirect(text);
        }

        function deleteMem(btn) { btn.closest('.polaroid').remove(); }
        
        function switchScene(name) {
            activeScene = name;
            
            document.querySelectorAll('.scene').forEach(el => el.classList.remove('active'));
            document.getElementById('scene-' + name).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-' + name).classList.add('active');
            
            // Recalculate Layout if switching to chat (dock might have moved slightly or re-flow)
            if(name === 'chat') {
               requestAnimationFrame(renderChat);
            }
        }

        // Init
        setLang('en');
    </script>
</body>
</html>
