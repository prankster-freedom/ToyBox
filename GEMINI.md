# エージェントが遵守すべきルール

このドキュメントは、エージェントであるあなたが、このプロジェクトで開発作業を行う際に遵守すべきルールとワークフローを定義します。

## 1. 最重要原則 (Core Principles)

以下の原則は、すべての作業の基礎となる最優先事項です。

### 1.1. 全てのソフトウェア変更はここで定義した工程に分けて進めること

工程 1: 要求獲得と要求分析、計画
工程 2-1: アーキテクチャ設計とブランチ作成
工程 2-2: 詳細設計
工程 3: 実装
工程 4: 付帯成果物作成
工程 5: コミット
工程 6: リモートリポジトリへの push とプルリクエスト作成

### 1.2. 厳格な承認ベースの作業進行

すべての作業において、一つの工程が完了したら、その結果を報告し、次のアクションについて**必ずユーザーからのプロンプトによる明確な承認を得てください。** ユーザーからの指示がない限り、複数の操作をまとめて実行したり、次のステップを推測して進めたりしてはいけません。

### 1.3. 工程の進行順序

- 通常は工程 1 から工程 6 まで、工程 1、工程 2、工程 3、工程 4、工程 5、工程 6 の順番に進行する
- 作業の実施後やチャットで何かしら指摘があったときは、結果を振り返り、必要であれば前工程の成果物を見直すために前工程に戻ることを提案する

---

## 2. 各工程の詳細ルール

### 工程 1: 要求獲得と要求分析、計画

1. まず最初に、[1.SPEC.md](./doc/1.SPEC.md)が既に存在するか確認します。

   - 存在する場合：既存の内容を十分に理解し、それをベースに作業を進めます
   - 存在しない場合：新規に作成します

2. 要求仕様の分析と更新：

   - 既存の要求事項を確認し、不明点があれば質問します
   - 新たな要求の追加や変更が必要な場合は提案します
   - ドキュメントの構成や文章表現に改善の余地がある場合は、具体的な修正案を提案します
   - 機能要求（FR）、非機能要求（NFR）を ID 管理します
   - ユースケース図やシーケンス図は必ず PlantUML 形式で`1.SPEC.md`内に直接記載します
     **注意: シーケンス図には、システムとアクター間の関わりのみを記載してください。システム内部の機能間のやり取りは設計情報のため、記載してはいけません**

3. 合意形成：
   - 要求仕様の変更案と次の工程以降の作業計画について、ユーザーと協議します
   - 合意に至った経緯や根拠をドキュメントに残します
   - 最終版のドキュメントについてユーザーから**明示的に承認を得たら**、次の「設計」工程に進みます

### 工程 2-1: アーキテクチャ設計とブランチ作成

1. まず最初に、[2.DESIGN.md](./doc/2.DESIGN.md)が既に存在するか確認します。

   - 存在する場合：既存の内容を十分に理解し、それをベースに作業を進めます
   - 存在しない場合：新規に作成します

2. アーキテクチャ設計：

   - [arc42](https://arc42.org/) などの確立されたテンプレートを参考に、アーキテクチャ設計を構造化して記述します。

3. 合意形成：

   - アーキテクチャや利用技術の案について、ユーザーと協議します
   - ブランチ戦略についてもユーザーに提示・**承認を求めます。**
   - 最終版のドキュメントについてユーザーから**明示的に承認を得たら**、次の「詳細設計」工程に進みます

### 工程 2-2: 詳細設計

- 詳細設計を行い、結果をユーザーとレビューしてください。
- 合意できたら、合意に至った経緯や根拠もドキュメントに残してください。
- 最終版のドキュメントについて、ユーザーに報告・**承認を求めます。**

### 工程 3: 実装

- 新規機能は、まずスケルトン（関数、API、イベントハンドラ等）から実装し、次に詳細ロジックを実装します。呼び出し前後のエラー判定や例外処理も実装します。
- **【重要】** **一つのファイル修正やコマンド実行ごとに**、ユーザーに報告・**承認を求めます。**
- サーバーの起動や API の実行といった動的テスト（動作確認）は、ユーザーの**承認なしに行ってはいけません。**

### 工程 4: 付帯成果物作成

- 仕様書、設計書、実装コード以外に下記も作成してください。

  - [ローカル開発環境の設定及び操作マニュアル](./doc/9.運用資料_ローカル開発環境の設定及び操作マニュアル.md)
  - [Google Cloud サービスの環境初期設定マニュアル](./doc/9.Google_Cloud_環境初期設定マニュアル.md)
  - [デプロイ手順](./doc/9.運用資料_DEPLOYMENT.md)
  - [エンドユーザー向け説明書](./doc/9.運用資料_USER_MANUAL.md)

- 結果をユーザーとレビューしてください。
- 合意できたら、合意に至った経緯や根拠もドキュメントに残してください。
- 最終版のドキュメントについて、ユーザーに報告・**承認を求めます。**

### 工程 5: コミット

- ユーザーからコミットの指示があった場合にのみ、このステップに進みます。
- 1. `git status`, `git diff` で変更内容を確認し、ユーザーに報告・**承認を求めます。**
- 2. コミットメッセージ案を提案し、ユーザーの**承認を得ます。**
- 3. `git commit` を実行し、ユーザーに報告・**承認を求めます。**

### 工程 6: リモートリポジトリへの push とプルリクエスト作成

- `git push` と pull リクエスト作成は、ユーザーから**明確な指示があった場合にのみ**実行します。

---

## 3. 特別な状況への対応 (Handling Special Situations)

### 3.1. 不具合対応

- SDK や API 関連の不具合は、場当たり的な対応ではなく、公式ドキュメントや仕様を厳密に確認し、エラーメッセージの根本原因を特定してから修正案を提案します。
- ツールや環境が原因で操作が失敗した場合（例: `git commit`の文字化け問題）、その原因を正直に報告し、環境の制約内で実現可能な代替案をユーザーと協議します.
