# 詳細設計: ロギングミドルウェア (`middleware/logger.js`)

## 概要

リクエストとレスポンスの情報をログに記録する。また、開発モードではデバッグログをレスポンスヘッダーまたはボディに含めるためのコンテキスト管理を行う。

## 依存関係

- `node:async_hooks` (`AsyncLocalStorage`)

## コンポーネント

### `AsyncLocalStorage` インスタンス

- リクエストスコープごとのログストレージを管理する。

### `requestLogger(req, res, next)`

- **目的**: リクエスト開始時のログ記録とコンテキスト初期化。
- **処理**:
  1. `AsyncLocalStorage.run()` で新しいコンテキストを作成。
  2. コンテキスト内に空のログ配列 `[]` を用意。
  3. リクエストメソッド、URL、IP アドレスなどをログ配列に追加。
  4. `next()` を呼び出す。

### `responseLogger` (または `res.send` のオーバーライド)

- **目的**: レスポンス送信時のログ記録とデバッグ情報の注入。
- **処理**:
  1. レスポンス送信直前にフック。
  2. ステータスコード、処理時間をログ記録。
  3. **開発モードの場合**:
     - `AsyncLocalStorage` から蓄積されたログ配列を取得。
     - JSON レスポンスであれば、`_debug` フィールドにログ配列を追加。
     - または `X-Debug-Logs` ヘッダーに JSON 文字列として追加（サイズ制限に注意）。

### `log(level, message, meta)`

- **目的**: アプリケーション内のどこからでもログを記録するヘルパー関数。
- **処理**:
  1. コンソールに出力 (`console.log` / `console.error`)。
  2. 現在の `AsyncLocalStorage` ストアが存在すれば、そこにもログオブジェクトを追加する。
